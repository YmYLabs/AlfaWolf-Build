name: Build AlfaWolf Linux

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'S√ºr√ºm numarasƒ± (√∂rn: 1.0, 2.1, 3.0)'
        required: true
        type: string
      release_type:
        description: 'S√ºr√ºm tipi'
        required: true
        type: choice
        options:
          - Beta
          - Preview
          - Final

jobs:
  build:
    name: Build AlfaWolf ${{ inputs.version }} ${{ inputs.release_type }}
    runs-on: ubuntu-latest
    container:
      image: debian:testing
      options: --privileged

    steps:
      - name: Bilgileri g√∂ster
        run: |
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë         üê∫ AlfaWolf Linux Builder          ‚ïë"
          echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
          echo "‚ïë  S√ºr√ºm: ${{ inputs.version }}"
          echo "‚ïë  Tip: ${{ inputs.release_type }}"
          echo "‚ïë  Masa√ºst√º: KDE Plasma (Wayland)"
          echo "‚ïë  Tarih: $(date '+%Y-%m-%d %H:%M')"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Baƒüƒ±mlƒ±lƒ±klarƒ± kur
        run: |
          apt-get update
          apt-get install -y \
            live-build \
            debootstrap \
            squashfs-tools \
            xorriso \
            isolinux \
            syslinux-efi \
            grub-pc-bin \
            grub-efi-amd64-bin \
            grub-efi-ia32-bin \
            mtools \
            dosfstools \
            debian-archive-keyring \
            ca-certificates \
            gnupg

      - name: S√ºr√ºm bilgilerini ayarla
        run: |
          VERSION="${{ inputs.version }}"
          TYPE="${{ inputs.release_type }}"
          
          mkdir -p config/includes.chroot/etc
          cat > config/includes.chroot/etc/os-release << EOF
          PRETTY_NAME="AlfaWolf Linux ${VERSION} ${TYPE}"
          NAME="AlfaWolf"
          VERSION_ID="${VERSION}"
          VERSION="${VERSION} (${TYPE})"
          VERSION_CODENAME=$(echo ${TYPE} | tr '[:upper:]' '[:lower:]')
          ID=alfawolf
          ID_LIKE=debian
          HOME_URL="https://github.com/YmYLabs/AlfaWolf"
          SUPPORT_URL="https://github.com/YmYLabs/AlfaWolf/issues"
          BUG_REPORT_URL="https://github.com/YmYLabs/AlfaWolf/issues"
          EOF
          
          mkdir -p config/includes.chroot/etc/alfawolf
          cat > config/includes.chroot/etc/alfawolf/release << EOF
          ALFAWOLF_VERSION=${VERSION}
          ALFAWOLF_TYPE=${TYPE}
          ALFAWOLF_BUILD_DATE=$(date '+%Y-%m-%d')
          ALFAWOLF_DESKTOP=KDE Plasma
          ALFAWOLF_SESSION=Wayland
          EOF
          
          # Welcome app config g√ºncelle
          sed -i "s/\"version\": \".*\"/\"version\": \"${VERSION}\"/" config/includes.chroot/usr/share/alfawolf-welcome/config.json
          sed -i "s/\"release_type\": \".*\"/\"release_type\": \"${TYPE}\"/" config/includes.chroot/usr/share/alfawolf-welcome/config.json

      - name: Live-build yapƒ±landƒ±r
        run: |
          chmod +x auto/*
          lb config

      - name: ISO olu≈ütur
        run: |
          lb build 2>&1 | tee build.log
        timeout-minutes: 180

      - name: ISO'yu yeniden adlandƒ±r
        run: |
          VERSION="${{ inputs.version }}"
          TYPE="${{ inputs.release_type }}"
          DATE=$(date +%Y%m%d)
          
          case ${TYPE} in
            Beta)
              FILENAME="AlfaWolf-${VERSION}-beta-${DATE}-amd64.iso"
              ;;
            Preview)
              FILENAME="AlfaWolf-${VERSION}-preview-${DATE}-amd64.iso"
              ;;
            Final)
              FILENAME="AlfaWolf-${VERSION}-${DATE}-amd64.iso"
              ;;
          esac
          
          mv alfawolf-linux-amd64.hybrid.iso ${FILENAME}
          sha256sum ${FILENAME} > ${FILENAME}.sha256
          
          cat > BUILD_INFO.txt << EOF
          ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
          ‚ïë       AlfaWolf Linux Build Bilgileri       ‚ïë
          ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
          ‚ïë  S√ºr√ºm: ${VERSION} ${TYPE}
          ‚ïë  Masa√ºst√º: KDE Plasma 6 (Wayland)
          ‚ïë  Taban: Debian Testing
          ‚ïë  Build: $(date '+%Y-%m-%d %H:%M:%S UTC')
          ‚ïë  Dosya: ${FILENAME}
          ‚ïë  SHA256: $(cat ${FILENAME}.sha256 | cut -d' ' -f1)
          ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
          
          GitHub: https://github.com/YmYLabs/AlfaWolf
          EOF
          
          echo "FILENAME=${FILENAME}" >> $GITHUB_ENV

      - name: ISO'yu y√ºkle
        uses: actions/upload-artifact@v4
        with:
          name: AlfaWolf-${{ inputs.version }}-${{ inputs.release_type }}
          path: |
            AlfaWolf-*.iso
            AlfaWolf-*.iso.sha256
            BUILD_INFO.txt
          retention-days: 30
          compression-level: 0

      - name: Build log y√ºkle
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-log-${{ inputs.version }}-${{ inputs.release_type }}
          path: build.log
          retention-days: 7
